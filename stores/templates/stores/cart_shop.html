{% extends 'basic.html' %}
{% load static %}

{% block content %}
    <head>
        <script src="https://kit.fontawesome.com/9417a4ac8c.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="{% static 'css/cart-shop-style.css' %}">

        <!-- Feather Icon (Installation) -->
        <script src="https://unpkg.com/feather-icons"></script>
    </head>

    <body>
        <div class="cart">
            <div class="container">
                <div class="card-title">
                    <div class="cart-title-product">
                        {% if owner %}
                            {% for data in owner %}
                                {% if forloop.first %}
                                    <div class="instruction">
                                        <p class="user">{{ data.user }},</p>
                                        <p>Checkout list produk yang akan kamu beli sekarang juga!</p>
                                    </div>
                                {% endif %}
                            {% empty %}

                            {% endfor %}
                        {% endif %}

                        <div class="cart-subtitle">
                            <p class="product">Product</p>
                            <p class="units">Unit Price</p>
                            <p class="numbers">Quantity</p>
                            <p class="total-all">Total Price</p>
                            <p>Action</p>
                        </div><hr>
                    </div>
                </div>
                <div class="card-product">
                    <div class="cart-details-product">
                        {% for data in owner %}
                            <div class="cart-lists">
                                {% if data.product_smartphone %}
                                    <h6><i class="fa-solid fa-store"></i> <a href="{% url 'seller_store' data.product_smartphone.owner.store_name %}">{{ data.product_smartphone.owner }}</a></h6>
                                {% endif %}
                                {% if data.product_food %}
                                    <h6><i class="fa-solid fa-store"></i> <a href="{% url 'seller_store' data.product_food.food_owner.store_name %}">{{ data.product_food.food_owner }}</a></h6>
                                {% endif %}
                                {% if data.product_smartphone %}
                                    <div class="product-smartphone">
                                        <img src="{{ data.product_smartphone.image.url }}">
                                        <p><a href="{% url 'smartphone_show' data.product_smartphone.pk %}">{{ data.product_smartphone|truncatechars:65 }}</a></p>
                                    </div>
                                {% endif %}
                                {% if data.product_food %}
                                    <div class="product-food">
                                        <img src="{{ data.product_food.food_image.url }}">
                                        <p><a href="{% url 'food_show' data.product_food.pk %}">{{ data.product_food|truncatechars:65 }}</a></p>
                                    </div>
                                {% endif %}
                                <div class="product-price" data-id="{{ data.id }}">
                                    Rp.{{ data.formatted_price }}
                                </div>
                                <div class="product-quantity">
                                    <!-- <span>{{ data.quantity }}</span> -->
                                    <button type="button" class="minus" onclick="decreaseQuantity('{{ data.id }}')">-</button>
                                    <span id="quantity{{ data.id }}" class="quantity-now" name="quantity{{ data.id }}" data-product-type="{{ data.categories }}">{{ data.quantity }}</span>
                                    <button type="button" class="plus" onclick="increaseQuantity('{{ data.id }}')">+</button>
                                </div>
                                <!-- Input hidden to store the updated quantity value -->
                                <input type="hidden" name="selected_products" value="{{ data.id }}">
                                <input type="hidden" name="quantity{{ data.id }}" id="quantity_input_{{ data.id }}" value="{{ data.quantity }}">
                                <!--  -->
                                <div class="total_price" id="totalPrice{{ data.id }}">
                                    <p>Rp.{{ data.formatted_price }}</p>
                                </div>
                                <div class="product-action">
                                    <!-- <form action="{% url 'delete_cart_item' data.id %}" method="post">
                                        {% csrf_token %}
                                        <input type="submit" class="btn btn-outline-danger">Delete</input>
                                    </form> -->
                                    <i data-feather="trash-2" class="remove-item" data-id="{{ data.id }}"></i>
                                </div>
                            </div>
                            <form action="{% url 'cart_shop' %}" method="post">
                                {% csrf_token %}
                                
                                <div class="choose">
                                    {% if data.product_smartphone %}
                                        <input type="checkbox" class="product-checkbox" data-id="{{ data.id }}" data-name="{{ data.product_smartphone.name }}" data-image="{{ data.product_smartphone.image.url }}" data-price="{{ data.total_price }}">
                                    {% elif data.product_food %}
                                        <input type="checkbox" class="product-checkbox" data-id="{{ data.id }}" data-name="{{ data.product_food.food_name }}" data-image="{{ data.product_food.food_image.url }}" data-price="{{ data.total_price }}">
                                    {% endif %}
                                    <input type="hidden" name="quantity{{ data.id }}" id="quantity_input_{{ data.id }}">
                                </div>
                                
                            </form><hr>
                        {% endfor %}
                        <div id="checkout-list">
                            <h3>Checkout List</h3>
                            <ul id="checkout-items"></ul>
                        </div>
                        
                        <!-- Shipping Options -->
                        <div id="shipping-options-container">
                            <div class="shippingOptions">
                                <p>Opsi Pengiriman:</p>
                                <button class="pilihButton">Pilih</button>
                            </div>
                            <!-- Pop Up Form -->
                            <div class="popUpForm">
                                <form id="shippingForm" method="POST">
                                    {% csrf_token %}
                                    <div class="form-1">
                                        {% for delivery in shipping_types %}
                                            <div class="chooseTypes">
                                                <input type="radio" name="delivery_type" value="{{ delivery.delivery_type }}">
                                                <label>{{ delivery.delivery_type }}</label>
                                                <span>Rp.{{ delivery.formatted_price }}</span>
                                            </div>
                                            {% if delivery.delivery_type == 'Regular' %}
                                                <div class="estimated">
                                                    <p class="estimation-text">Estimasi Sampai:</p>
                                                    <p class="estimation-time">
                                                        {% for regular in estimated_time_regular%}
                                                            {{ regular }}
                                                        {% endfor %}
                                                    </p>
                                                </div>
                                            {% endif %}
                                            {% if delivery.delivery_type == 'Fast' %}
                                                <div class="estimated">
                                                    <p class="estimation-text">Estimasi Sampai:</p>
                                                    <p class="estimation-time">
                                                        {% for fast in estimated_time_fast %}
                                                            {{ fast }}
                                                        {% endfor %}
                                                    </p>
                                                </div>
                                            {% endif %}
                                            {% if delivery.delivery_type == 'Cargo' %}
                                                <div class="estimated">
                                                    <p class="estimation-text">Estimasi sampai:</p>
                                                    <p class="estimation-time">
                                                        {% for cargo in estimated_time_cargo %}
                                                            {{ cargo }}
                                                        {% endfor %}
                                                    </p>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="saveButton">Save</button>
                                </form>
                            </div>
                            <div class="showDelivery"></div>
                        </div>

                        <!-- Payment method integrate with midtrans -->
                        <div class="payment-method" style="display: none;"></div>

                        <div class="summaryCheckout">
                            <div class="productDetailsList">
                                <h3 class="productNumbersText">Product yang dibeli:</h3>
                                <h3 id="productNumbers">0</h3>
                                <!-- <h3 class="productNamesText">Product Name:</h3> -->
                                <h3 id="productNames">0</h3>
                            </div>
                            <div class="productJumlahList">
                                <h3 class="totalProductText">Jumlah Produk:</h3>
                                <h3 id="totalProducts">0</h3>
                            </div>
                            <div class="totalCostList">
                                <h3 class="totalCostText">Total Biaya:</h3>
                                <h3 id="totalCost">Rp.0</h3>
                            </div>
                            <!-- Warning to select delivery/shipping options before checkout the product -->
                            <div id="delivery-warning">
                                <h3 class="warning-text">(Please choose the shipping/delivery option first!)</h3>
                            </div>
                        </div>

                        <!-- Checkout Button -->
                        <div class="checkoutButton">
                            <button class="checkout-button disabled" type="button" id="checkoutButton">Checkout</button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <script src="{% static 'js/cart-function.js' %}"></script>

        <!-- Feather Icon (Installation) -->
        <script>
            feather.replace();
        </script>

        <script>
            // Delete item with 'trash icon'
            document.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll(".remove-item").forEach(icon => {
                    icon.addEventListener("click", function() {
                        let productId = this.getAttribute("data-id");
                        let url = `{% url 'delete_cart_item' 0 %}`.replace('0', productId);

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                this.closest('.cart-lists').remove();
                            } else {
                                alert('Error deleting item/product');
                            }
                        })
                        .catch(error => {
                            console.error('Errornya:', error);
                        });
                    });
                });
            });

            // Create or Add Product into Checkout List
            document.addEventListener("DOMContentLoaded", () => {
                const checkboxOptions = document.querySelectorAll(".product-checkbox");
                const checkoutLists = document.getElementById("checkout-items");
                const checkoutListContainer = document.getElementById("checkout-list");
                const summaryCheckoutContainer = document.querySelector(".summaryCheckout");
                const productNumbersElement = document.getElementById("productNumbers");
                const productNamesElement = document.getElementById("productNames");
                const totalProductsElement = document.getElementById("totalProducts");
                const totalCostElement = document.getElementById("totalCost");
                const deliveryWarningElement = document.getElementById("delivery-warning");
                const checkoutButton = document.querySelector(".checkout-button");


                const toggleCheckoutListVisibility = () => {
                    if (checkoutLists.children.length > 0) {
                        checkoutListContainer.style.display = "block";
                        summaryCheckoutContainer.style.display = "block";
                    } else {
                        checkoutListContainer.style.display = "none";
                        summaryCheckoutContainer.style.display = "none";
                    }
                };

                // Update for the checkout total summary
                const updateSummaryCheckout = () => {
                    let uniqueProductId = new Set();
                    let totalProducts = 0;
                    let totalCost = 0;
                    // let deliverySelected = false;
                    let deliverySelectedForAllProducts = true;

                    // Get productNames from checkout list
                    let productNames = [];

                    checkoutLists.querySelectorAll("li").forEach(item => {
                        const productId = item.getAttribute("data-id");
                        const productName = item.getAttribute("data-name");
                        console.log("Checking item:", item);
                        console.log("Product Name Check:", productName);

                        const quantityText = item.querySelector("span").textContent.match(/Quantity: (\d+)/);
                        const priceText = item.querySelector("span").textContent.match(/-\s*Rp\.([\d.]+)/);
                        const deliveryCostText = item.querySelector(".formattedPrice")?.textContent.match(/Rp\.([\d.]+)/);
                        const selectedDelivery = item.querySelector(".showDelivery").innerHTML.trim();

                        if (productName) {
                            productNames.push(productName);
                        }

                        if (quantityText && priceText) {
                            const quantity = parseInt(quantityText[1], 10);
                            const price = parseInt(priceText[1].replace(/\./g, ''), 10); // Remove dots and convert to integer

                            totalProducts += quantity;
                            totalCost += price;

                            uniqueProductId.add(productId);
                        }

                        if (deliveryCostText) {
                            const deliveryCost = parseInt(deliveryCostText[1].replace(/\./g, ''), 10);
                            totalCost += deliveryCost;
                        }

                        // if (selectedDelivery) {
                        //     deliverySelected = true;
                        // }

                        if (!selectedDelivery) {
                            deliverySelectedForAllProducts = false;
                        }
                    });

                    // productNamesElement.textContent = productNames;
                    productNamesElement.textContent = productNames.join(', ');
                    console.log("product names array:", productNames);

                    productNumbersElement.textContent = `(${uniqueProductId.size})`;
                    // console.log("product numbers 1:", productNumbers);
                    totalProductsElement.textContent = totalProducts;
                    // console.log("product totals 1:", totalProducts);
                    
                    totalCostElement.textContent = `Rp.${totalCost.toLocaleString('id-ID')}`;

                    // Show or hide the delivery warning
                    // if (!deliverySelected) {
                    if (!deliverySelectedForAllProducts) {
                        deliveryWarningElement.style.display = "block";
                        // Turn off disabled feature on checkoutlist as default
                        checkoutButton.classList.add("disabled");
                    } else {
                        deliveryWarningElement.style.display = "none";
                        // Turn on disabled feature on checkoutlist as default
                        checkoutButton.classList.remove("disabled");
                    }
                };

                checkboxOptions.forEach(checkbox => {
                    checkbox.addEventListener("change", function() {
                        let productId = this.getAttribute("data-id")
                        let productName = this.getAttribute("data-name")
                        let productImage = this.getAttribute("data-image")
                        let quantitySpan = document.getElementById("quantity" + productId)
                        let productQuantity = quantitySpan.textContent;
                        let priceSpan = document.getElementById("totalPrice" + productId)
                        let productPrice = priceSpan.textContent;

                        if (this.checked) {
                            // Add product into checkout List
                            let listItem = document.createElement("li")
                            listItem.setAttribute("data-id", productId);
                            listItem.setAttribute("data-name", productName);
                            
                            // Create Product Image element
                            let imgElement = document.createElement("img");
                            imgElement.src = productImage;
                            imgElement.alt = productName;
                            imgElement.style.width = "50px";
                            imgElement.style.height = "50px";
                            imgElement.style.marginBottom = "1rem";
                            imgElement.style.marginRight = "1rem";

                            let textElement = document.createElement("span");
                            textElement.textContent = `${productName} (Quantity: ${productQuantity}) - ${productPrice}`;

                            // Add imgElement & textElement
                            listItem.appendChild(imgElement);
                            listItem.appendChild(textElement);

                            // Clone the shipping options
                            let shippingOptionsContainer = document.getElementById("shipping-options-container").cloneNode(true);
                            shippingOptionsContainer.style.display = "flex";
                            listItem.appendChild(shippingOptionsContainer);

                            // Add all ListItems
                            checkoutLists.appendChild(listItem);

                            console.log("Added list item:", listItem);

                            // console.log("product names 2:", productName);
                            // console.log("product quantity 2:", productQuantity);
                            // console.log("product quantity 2:", productQuantity);

                            // Add event listener to Choose button
                            let pilihButton = shippingOptionsContainer.querySelector(".pilihButton");
                            let popUpForm = shippingOptionsContainer.querySelector(".popUpForm");
                            let showDelivery = shippingOptionsContainer.querySelector(".showDelivery");

                            pilihButton.addEventListener('click', () => {
                                // Show popUpForm and hide the 'pilih' button at the same time
                                popUpForm.style.display = "block";
                                pilihButton.style.display = "none";

                                // Hide delivery types when popUpFrom is displayed
                                showDelivery.innerHTML = '';
                            });

                            // Add event listener to Save button
                            let saveButton = shippingOptionsContainer.querySelector(".saveButton");

                            saveButton.addEventListener('click', () => {
                                let selectedValue = popUpForm.querySelector('input[name="delivery_type"]:checked');
                                let add = showDelivery;

                                // Close popUpForm
                                popUpForm.style.display = "none";
                                pilihButton.style.display = "block";

                                // Get the estimated time based on the selected delivery_type
                                let estimatedTime;

                                // Show selected delivery_options
                                if (selectedValue.value === 'Regular') {
                                    let formattedPrice = selectedValue.nextElementSibling.nextElementSibling.textContent;
                                    estimatedTime = "{% for regular in estimated_time_regular %} {{ regular }} {% endfor %}";
                                    add.innerHTML = `<div class="selectedValue">${selectedValue.value}</div> <div class="formattedPrice">${formattedPrice}</div> <div class="estimated-Time"> Estimated Time: </div> <div class="estimatedTime">${estimatedTime}</div>`;
                                    // Set the style
                                    add.classList.add('showSelectedTypes')
                                } else if (selectedValue.value === 'Fast') {
                                    let formattedPrice = selectedValue.nextElementSibling.nextElementSibling.textContent;
                                    estimatedTime = "{% for fast in estimated_time_fast %} {{ fast }} {% endfor %}";
                                    add.innerHTML = `<div class="selectedValue">${selectedValue.value}</div> <div class="formattedPrice">${formattedPrice}</div> <div class="estimated-Time"> Estimated Time: </div> <div class="estimatedTime">${estimatedTime}</div>`;
                                    // Set the style
                                    add.classList.add('showSelectedTypes')
                                } else if (selectedValue.value === 'Cargo') {
                                    let formattedPrice = selectedValue.nextElementSibling.nextElementSibling.textContent;
                                    estimatedTime = "{% for cargo in estimated_time_cargo %} {{ cargo }} {% endfor %}";
                                    add.innerHTML = `<div class="selectedValue">${selectedValue.value}</div> <div class="formattedPrice">${formattedPrice}</div> <div class="estimated-Time"> Estimated Time: </div> <div class="estimatedTime">${estimatedTime}</div>`;
                                    // Set the style
                                    add.classList.add('showSelectedTypes')
                                }

                                // Update summaryCheckout after selecting delivery type
                                updateSummaryCheckout();
                            });
                        } else {
                            // Remove the product from checkout lists
                            let listItem = checkoutLists.querySelector(`li[data-id="${productId}"]`);
                            if (listItem) {
                                listItem.remove();
                            }
                        }

                        // update hidden input with the current quantity
                        document.getElementById('quantity_input_' + productId).value = productQuantity;

                        // Toggle checkout list visibility
                        toggleCheckoutListVisibility();

                        // Update summaryCheckout after adding or removing product
                        updateSummaryCheckout();
                    });
                });

                // Initial check to see if the list should be visible
                // toggleCheckoutListVisibility();
            });

            // Send data in 'checkout list' into whatsapp
            // document.addEventListener("DOMContentLoaded", () => {
                //     const checkoutButton = document.getElementById("checkoutButton");
                

            // Send data in 'checkout list' into whatsapp
            checkoutButton.addEventListener("click", () => {
                if (checkoutButton.classList.contains("disabled")) {
                    return;
                }

                // Get whatsapp number from views.py
                const phoneNumber = "{{ phone_number }}";

                // Get data from showDelivery
                // const showDeliveryElement = document.querySelector(".showDelivery");
                // const selectedValue = showDeliveryElement.querySelector(".selectedValue")?.textContent || '';
                // const formattedPrice = showDeliveryElement.querySelector(".formattedPrice")?.textContent || '';
                // const estimatedTime = showDeliveryElement.querySelector(".estimatedTime")?.textContent || '';

                // Get productId from checkout list
                let productIds = [];
                // console.log("product id list:", productIds);

                let productNames = [];
                // console.log("product name lists:", productNames)

                let deliveryDetails = [];

                const checkoutLists = document.getElementById("checkout-items");

                checkoutLists.querySelectorAll("li").forEach(item => {
                    // productIds.push(item.getAttribute("data-id"));
                    // productNames.push(item.getAttribute("data-name"));
                    // console.log("product id yg dipilih:", productIds);
                    // console.log("product name yg dipilih:", productNames);

                    const productId = item.getAttribute("data-id");
                    const productName = item.getAttribute("data-name");
                    const selectedValue = item.querySelector(".selectedValue")?.textContent || '';
                    const formattedPrice = item.querySelector(".formattedPrice")?.textContent || '';
                    const estimatedTime = item.querySelector(".estimatedTime")?.textContent || '';

                    productIds.push(productId);
                    productNames.push(productName);

                    deliveryDetails.push({
                        selectedValue,
                        formattedPrice,
                        estimatedTime
                    });
                });

                // Get data from summaryCheckout
                const summaryData = {
                    productOrdered: document.getElementById("productNumbers").textContent,
                    productQuantity: document.getElementById("totalProducts").textContent,
                    totalCost: document.getElementById("totalCost").textContent
                };

                // Format the message
                let message = `~ Checkout Details ~\n\n`;
                // To separate product into sections
                productIds.forEach((id, index) => {
                    message += `Product Id: ${id}\n`;
                    message += `Product Name: ${productNames[index]}\n`;
                    message += `Delivery Type: ${deliveryDetails[index].selectedValue}\n`;
                    message += `Delivery Price: ${deliveryDetails[index].formattedPrice}\n`;
                    message += `Estimated Time: ${deliveryDetails[index].estimatedTime}\n`;
                    message += `-----------------------------------------------------------------------------------\n`;
                });
                // message += `Product Id: ${productIds.join(', ')}\n`;
                // message += `Product Names: ${productNames.join(', ')}\n`;
                // message += `\nDelivery:\n`;
                // message += `Delivery Type: ${selectedValue}\n`;
                // message += `Price: ${formattedPrice}\n`;
                // message += `Estimated Time: ${estimatedTime}\n`;
                message += `\nProduct Ordered: ${summaryData.productOrdered}\n`;
                message += `Product Quantity: ${summaryData.productQuantity}\n`;
                message += `Total Cost: ${summaryData.totalCost}\n`;

                // Encode the message for URL
                // const encodedMessage = encodeURIComponent(message);

                // Open Whatsapp URL
                // const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappURL, '_blank');
            });
            // });
        </script>
    </body>
{% endblock %}