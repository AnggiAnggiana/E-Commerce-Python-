{% extends 'basic.html' %}
{% load static %}

{% block content %}
    <head>
        <script src="https://kit.fontawesome.com/9417a4ac8c.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="{% static 'css/cart-shop-style.css' %}">

        <!-- Feather Icon (Installation) -->
        <script src="https://unpkg.com/feather-icons"></script>
    </head>

    <body>
        <div class="cart">
            <div class="container">
                <div class="card-title">
                    <div class="cart-title-product">
                        {% if owner %}
                            {% for data in owner %}
                                {% if forloop.first %}
                                    <div class="instruction">
                                        <p class="user">{{ data.user }},</p>
                                        <p>Checkout list produk yang akan kamu beli sekarang juga!</p>
                                    </div>
                                {% endif %}
                            {% empty %}

                            {% endfor %}
                        {% endif %}

                        <div class="cart-subtitle">
                            <p class="product">Product</p>
                            <p class="units">Unit Price</p>
                            <p class="numbers">Quantity</p>
                            <p class="total-all">Total Price</p>
                            <p>Action</p>
                        </div><hr>
                    </div>
                </div>
                <div class="card-product">
                    <div class="cart-details-product">
                        {% for data in owner %}
                            <div class="cart-lists">
                                {% if data.product_smartphone %}
                                    <h6><i class="fa-solid fa-store"></i> <a href="{% url 'seller_store' data.product_smartphone.owner.store_name %}">{{ data.product_smartphone.owner }}</a></h6>
                                {% endif %}
                                {% if data.product_food %}
                                    <h6><i class="fa-solid fa-store"></i> <a href="{% url 'seller_store' data.product_food.food_owner.store_name %}">{{ data.product_food.food_owner }}</a></h6>
                                {% endif %}
                                {% if data.product_smartphone %}
                                    <div class="product-smartphone">
                                        <img src="{{ data.product_smartphone.image.url }}">
                                        <p><a href="{% url 'smartphone_show' data.product_smartphone.pk %}">{{ data.product_smartphone|truncatechars:65 }}</a></p>
                                    </div>
                                {% endif %}
                                {% if data.product_food %}
                                    <div class="product-food">
                                        <img src="{{ data.product_food.food_image.url }}">
                                        <p><a href="{% url 'food_show' data.product_food.pk %}">{{ data.product_food|truncatechars:65 }}</a></p>
                                    </div>
                                {% endif %}
                                <div class="product-price" data-id="{{ data.id }}" id="priceOriginal{{ data.id }}">
                                    Rp.{{ data.formatted_price }}
                                </div>
                                <div class="product-quantity">
                                    <!-- <span>{{ data.quantity }}</span> -->
                                    <button type="button" class="minus" onclick="decreaseQuantity('{{ data.id }}')">-</button>
                                    <span id="quantity{{ data.id }}" class="quantity-now" name="quantity{{ data.id }}" data-product-type="{{ data.categories }}">{{ data.quantity }}</span>
                                    <button type="button" class="plus" onclick="increaseQuantity('{{ data.id }}')">+</button>
                                </div>
                                <!-- Input hidden to store the updated quantity value -->
                                <input type="hidden" name="selected_products" value="{{ data.id }}">
                                <input type="hidden" name="quantity{{ data.id }}" id="quantity_input_{{ data.id }}" value="{{ data.quantity }}">
                                <!--  -->
                                <div class="total_price" id="totalPrice{{ data.id }}">
                                    <p>Rp.{{ data.formatted_price }}</p>
                                </div>
                                <div class="product-action">
                                    <i data-feather="trash-2" class="remove-item" data-id="{{ data.id }}"></i>
                                </div>
                            </div>
                            <form action="{% url 'cart_shop' %}" method="post">
                                {% csrf_token %}
                                
                                <div class="choose">
                                    {% if data.product_smartphone %}
                                        <input type="checkbox" class="product-checkbox" data-id="{{ data.id }}" data-name="{{ data.product_smartphone.name }}" data-image="{{ data.product_smartphone.image.url }}" data-price="{{ data.total_price }}">
                                    {% elif data.product_food %}
                                        <input type="checkbox" class="product-checkbox" data-id="{{ data.id }}" data-name="{{ data.product_food.food_name }}" data-image="{{ data.product_food.food_image.url }}" data-price="{{ data.total_price }}">
                                    {% endif %}
                                    <input type="hidden" name="quantity{{ data.id }}" id="quantity_input_{{ data.id }}">
                                </div>
                                
                            </form><hr>
                        {% endfor %}
                        <div id="checkout-list">
                            <h3>Checkout List</h3>
                            <!-- Buyer shipping address -->
                            <div class="cart-title-address">
                                <div class="title-address">
                                    <h5>Buyer Details</h5>
                                </div>
                                <div class="customer-details">
                                    {% if owner %}
                                        {% for data in owner %}
                                            {% if forloop.first %}
                                                <div class="buyer-details-container">
                                                    <h5 class="buyer">Recipient:</h5>
                                                    <p id="buyer-name">{{ data.user }}</p>
                                                    <textarea id="input_buyer" name="user_buyer"> {{ data.user }}</textarea>
                                                    <h5 class="contact-recipient">Contact:</h5>
                                                    <p id="buyer-contact">{{ data.user.phone_number }}</p>
                                                    <textarea id="input_contact" name="user_contact"> {{ data.user.phone_number }} </textarea>
                                                </div>
                                                <div id="address-container">
                                                    <h5 class="address-buyer">Alamat:</h5>
                                                    <p id="text_address">{{ data.user.street }}, {{ data.user.district }}, {{ data.user.city }}, {{ data.user.province }}, {{ data.user.country }} ({{ data.user.postal_code }})</p>
                                                    <textarea id="input_address" name="user_address">{{ data.user.street }}, {{ data.user.district }}, {{ data.user.city }}, {{ data.user.province }}, {{ data.user.country }} ({{ data.user.postal_code }})</textarea>
                                                    <button id="saveAddress">Save</button>
                                                </div>
                                                <button id="editAddress">Edit</button>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="customer-contact">
                                    {% for product in product_from_cart %}
                                        <p id="contact-info"> Contact: {{ product.user.phone_number }} </p>
                                    {% endfor %}
                                </div>
                            </div>
                            

                            <!-- Checkout list item -->
                            <h5 class="product-details">Product Details</h5>
                            <ul id="checkout-items"></ul>
                        </div>
                        
                        <!-- Shipping Options -->
                        <div id="shipping-options-container">
                            <div class="shippingOptions">
                                <p>Opsi Pengiriman:</p>
                                <button class="pilihButton">Pilih</button>
                            </div>
                            <!-- Pop Up Form -->
                            <div class="popUpForm">
                                <form id="shippingForm" method="POST">
                                    {% csrf_token %}
                                    <div class="form-1">
                                        {% for delivery in shipping_types %}
                                            <div class="chooseTypes">
                                                <input type="radio" name="delivery_type" value="{{ delivery.delivery_type }}">
                                                <label>{{ delivery.delivery_type }}</label>
                                                <span>Rp.{{ delivery.formatted_price }}</span>
                                            </div>
                                            {% if delivery.delivery_type == 'Regular' %}
                                                <div class="estimated">
                                                    <p class="estimation-text">Estimasi Sampai:</p>
                                                    <p class="estimation-time">
                                                        {% for regular in estimated_time_regular%}
                                                            {{ regular }}
                                                        {% endfor %}
                                                    </p>
                                                </div>
                                            {% endif %}
                                            {% if delivery.delivery_type == 'Fast' %}
                                                <div class="estimated">
                                                    <p class="estimation-text">Estimasi Sampai:</p>
                                                    <p class="estimation-time">
                                                        {% for fast in estimated_time_fast %}
                                                            {{ fast }}
                                                        {% endfor %}
                                                    </p>
                                                </div>
                                            {% endif %}
                                            {% if delivery.delivery_type == 'Cargo' %}
                                                <div class="estimated">
                                                    <p class="estimation-text">Estimasi sampai:</p>
                                                    <p class="estimation-time">
                                                        {% for cargo in estimated_time_cargo %}
                                                            {{ cargo }}
                                                        {% endfor %}
                                                    </p>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="saveButton">Save</button>
                                </form>
                            </div>
                            <div class="showDelivery"></div>
                        </div>

                        <div class="payment-option">
                            <form id="payment-midtrans-form">
                                <input type="hidden" name="productNames" id="productNamesInput">
                                <input type="hidden" name="totalCost" id="totalCostInput">
                                <input type="hidden" name="totalQuantity" id="totalQuantityInput">
                                <button class="payment-button" type="button" id="payment-button">Opsi Pembayaran</button>
                            </form>
                        </div>

                        <!-- Payment method integrate with midtrans -->
                        <div class="payment-method" id="midtrans-payment-method"></div>

                        <div class="summaryCheckout">
                            <div class="productDetailsList">
                                <h3 class="productNumbersText">Product yang dibeli:</h3>
                                <h3 id="productNumbers">0</h3>
                                
                                <h3 id="productNames">0</h3>
                            </div>
                            <div class="productJumlahList">
                                <h3 class="totalProductText">Jumlah Produk:</h3>
                                <h3 id="totalProducts">0</h3>
                            </div>
                            <div class="totalCostList">
                                <h3 class="totalCostText">Total Biaya:</h3>
                                <h3 id="totalCost">Rp.0</h3>
                            </div>
                            <!-- Warning to select delivery/shipping options before checkout the product -->
                            <div id="delivery-warning">
                                <h3 class="warning-text">(Please choose the shipping/delivery option first!)</h3>
                            </div>
                        </div>

                        <!-- Checkout Button -->
                        <div class="checkoutButton">
                            <button class="checkout-button disabled" type="button" id="checkoutButton">Checkout</button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <script src="{% static 'js/cart-function.js' %}"></script>

        <!-- Feather Icon (Installation) -->
        <script>
            feather.replace();
        </script>

        <!-- Include Snap.js dynamically (MIDTRANS INTEGRATION) -->
        <script>
            const script = document.createElement('script');
            script.src = "https://app.sandbox.midtrans.com/snap/snap.js";
            script.setAttribute('data-client-key', "{{ client_key }}");
            document.head.appendChild(script);
        </script>

        <script>
            // Delete item with 'trash icon'
            document.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll(".remove-item").forEach(icon => {
                    icon.addEventListener("click", function() {
                        let productId = this.getAttribute("data-id");
                        let url = `{% url 'delete_cart_item' 0 %}`.replace('0', productId);

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                this.closest('.cart-lists').remove();
                            } else {
                                alert('Error deleting item/product');
                            }
                        })
                        .catch(error => {
                            console.error('Errornya:', error);
                        });
                    });
                });
            });


            // Edit User/Buyer Details Address
            let editButton = document.getElementById("editAddress");
            let nameText = document.getElementById("buyer-name");
            let nameInput = document.getElementById("input_buyer");
            let contactText = document.getElementById("buyer-contact");
            let contactInput = document.getElementById("input_contact");
            let addressText = document.getElementById("text_address");
            let addressInput = document.getElementById("input_address");
            let saveButton = document.getElementById("saveAddress");

            editButton.addEventListener("click", () => {
                editButton.style.display = "none";
                nameText.style.display = "none";
                nameInput.style.display = "block";
                contactText.style.display = "none";
                contactInput.style.display = "block";
                addressText.style.display = "none";
                addressInput.style.display = "block";
                saveButton.style.display = "block";

                // Set the dynamic marginTop
                adjustContactInfo()
            });

            saveButton.addEventListener("click", () => {
                editButton.style.display = "block";
                nameText.style.display = "block";
                nameText.innerText = nameInput.value;
                nameInput.style.display = "none";
                contactText.style.display = "block";
                contactText.innerText = contactInput.value;
                contactInput.style.display = "none";
                addressText.style.display = "block";
                addressText.innerText = addressInput.value;
                addressInput.style.display = "none";
                saveButton.style.display = "none";
                
                // Set the dynamic marginTop
                adjustContactInfo()
            })

            // Script to set dynamic marginTop adjustment for contact information
            const adjustContactInfo = () => {
                let contactInfo = document.getElementById("contact-info")
                let addressText = document.getElementById("text_address")
                let addressInput = document.getElementById("input_address")

                if (addressText.style.display === "block") {
                    contactInfo.style.marginTop = "0px";
                } else if (addressInput.style.display === "block") {
                    contactInfo.style.marginTop = "-115px";
                }
            }

            window.onload = adjustContactInfo;


            // Create or Add Product into Checkout List
            document.addEventListener("DOMContentLoaded", () => {
                const checkboxOptions = document.querySelectorAll(".product-checkbox");
                const checkoutLists = document.getElementById("checkout-items");
                const checkoutListContainer = document.getElementById("checkout-list");
                const summaryCheckoutContainer = document.querySelector(".summaryCheckout");
                const productNumbersElement = document.getElementById("productNumbers");
                const productNamesElement = document.getElementById("productNames");
                const totalProductsElement = document.getElementById("totalProducts");
                const totalCostElement = document.getElementById("totalCost");
                const deliveryWarningElement = document.getElementById("delivery-warning");
                const checkoutButton = document.querySelector(".checkout-button");
                const form = document.getElementById("payment-midtrans-form");
                const totalCostInput = document.getElementById("totalCostInput");
                const totalQuantityInput = document.getElementById("totalQuantityInput");
                const productNamesInput = document.getElementById("productNamesInput");
                const paymentButton = document.getElementById("payment-button");
                const midtransForm = document.getElementById('payment-midtrans-form');


                const toggleCheckoutListVisibility = () => {
                    if (checkoutLists.children.length > 0) {
                        checkoutListContainer.style.display = "block";
                        summaryCheckoutContainer.style.display = "block";
                        paymentButton.style.display = "block";
                        checkoutButton.style.display = "block";
                    } else {
                        checkoutListContainer.style.display = "none";
                        summaryCheckoutContainer.style.display = "none";
                        paymentButton.style.display = "none";
                        checkoutButton.style.display = "none";
                    }
                };

                // Update for the checkout total summary
                const updateSummaryCheckout = () => {
                    let uniqueProductId = new Set();
                    let totalProducts = 0;
                    let totalCost = 0;
                    let totalPrices = 0;
                    let deliverySelectedForAllProducts = true;

                    // Get productNames from checkout list
                    let productNames = [];

                    checkoutLists.querySelectorAll("li").forEach(item => {
                        const productId = item.getAttribute("data-id");
                        const productName = item.getAttribute("data-name");
                        console.log("Checking item:", item);
                        console.log("Product Name Check:", productName);

                        const quantityText = item.querySelector("span").textContent.match(/Quantity: (\d+)/);
                        const priceText = item.querySelector("span").textContent.match(/-\s*Rp\.([\d.]+)/);

                        const deliveryCostText = item.querySelector(".formattedPrice")?.textContent.match(/Rp\.([\d.]+)/);
                        const selectedDelivery = item.querySelector(".showDelivery").innerHTML.trim();

                        if (productName) {
                            productNames.push(productName);
                        }

                        if (quantityText && priceText) {
                            const quantity = parseInt(quantityText[1], 10);
                            const price = parseInt(priceText[1].replace(/\./g, ''), 10);

                            totalProducts += quantity;
                            totalPrices += price;

                            totalCost += price * quantity

                            uniqueProductId.add(productId);
                        }

                        if (deliveryCostText) {
                            const deliveryCost = parseInt(deliveryCostText[1].replace(/\./g, ''), 10);
                            totalCost += deliveryCost;
                        }

                        if (!selectedDelivery) {
                            deliverySelectedForAllProducts = false;
                        }
                    });

                    // productNamesElement.textContent = productNames;
                    productNamesElement.textContent = productNames.join(', ');
                    console.log("product names array:", productNames);

                    productNumbersElement.textContent = `(${uniqueProductId.size})`;
                    // console.log("product numbers 1:", productNumbers);
                    totalProductsElement.textContent = totalProducts;
                    // console.log("product totals 1:", totalProducts);
                    
                    totalCostElement.textContent = `Rp.${totalCost.toLocaleString('id-ID')}`;

                    // Update hidden input fields
                    productNamesInput.value = JSON.stringify(productNames);
                    totalQuantityInput.value = JSON.stringify(totalProducts);
                    totalCostInput.value = JSON.stringify(totalCost);
                    // console.log('productNames:', productNamesInput.value)
                    // console.log('quantityProduct:', totalQuantityInput.value)
                    // console.log('totalCost:', totalCostInput.value)

                    // Show or hide the delivery warning
                    if (!deliverySelectedForAllProducts) {
                        deliveryWarningElement.style.display = "block";
                        // Turn off disabled feature on checkoutlist as default
                        checkoutButton.classList.add("disabled");
                    } else {
                        deliveryWarningElement.style.display = "none";
                        // Turn on disabled feature on checkoutlist as default
                        checkoutButton.classList.remove("disabled");
                    }
                };
                // Update summaryCheckout after selecting delivery type
                updateSummaryCheckout();

                checkboxOptions.forEach(checkbox => {
                    checkbox.addEventListener("change", function() {
                        let productId = this.getAttribute("data-id")
                        let productName = this.getAttribute("data-name")
                        let productImage = this.getAttribute("data-image")
                        let quantitySpan = document.getElementById("quantity" + productId)
                        let productQuantity = quantitySpan.textContent;
                        let priceSpan = document.getElementById("priceOriginal" + productId)
                        let productPrice = priceSpan.textContent;

                        if (this.checked) {
                            // Add product into checkout List
                            let listItem = document.createElement("li")
                            listItem.setAttribute("data-id", productId);
                            listItem.setAttribute("data-name", productName);
                            
                            // Create Product Image element
                            let imgElement = document.createElement("img");
                            imgElement.src = productImage;
                            imgElement.alt = productName;
                            imgElement.style.width = "50px";
                            imgElement.style.height = "50px";
                            imgElement.style.marginBottom = "1rem";
                            imgElement.style.marginRight = "1rem";

                            let textElement = document.createElement("span");
                            textElement.textContent = `${productName} (Quantity: ${productQuantity}) - ${productPrice}`;

                            // Add imgElement & textElement
                            listItem.appendChild(imgElement);
                            listItem.appendChild(textElement);

                            // Clone the shipping options
                            let shippingOptionsContainer = document.getElementById("shipping-options-container").cloneNode(true);
                            shippingOptionsContainer.style.display = "flex";
                            listItem.appendChild(shippingOptionsContainer);

                            // Add all ListItems
                            checkoutLists.appendChild(listItem);

                            console.log("Added list item:", listItem);

                            // Add event listener to Choose button
                            let pilihButton = shippingOptionsContainer.querySelector(".pilihButton");
                            let popUpForm = shippingOptionsContainer.querySelector(".popUpForm");
                            let showDelivery = shippingOptionsContainer.querySelector(".showDelivery");

                            pilihButton.addEventListener('click', () => {
                                // Show popUpForm and hide the 'pilih' button at the same time
                                popUpForm.style.display = "block";
                                pilihButton.style.display = "none";

                                // Hide delivery types when popUpFrom is displayed
                                showDelivery.innerHTML = '';
                            });

                            // Add event listener to Save button
                            let saveButton = shippingOptionsContainer.querySelector(".saveButton");

                            saveButton.addEventListener('click', () => {
                                let selectedValue = popUpForm.querySelector('input[name="delivery_type"]:checked');
                                let add = showDelivery;

                                // Close popUpForm
                                popUpForm.style.display = "none";
                                pilihButton.style.display = "block";

                                // Get the estimated time based on the selected delivery_type
                                let estimatedTime;

                                // Show selected delivery_options
                                if (selectedValue.value === 'Regular') {
                                    let formattedPrice = selectedValue.nextElementSibling.nextElementSibling.textContent;
                                    estimatedTime = "{% for regular in estimated_time_regular %} {{ regular }} {% endfor %}";
                                    add.innerHTML = `<div class="selectedValue">${selectedValue.value}</div> <div class="formattedPrice">${formattedPrice}</div> <div class="estimated-Time"> Estimated Time: </div> <div class="estimatedTime">${estimatedTime}</div>`;
                                    // Set the style
                                    add.classList.add('showSelectedTypes')
                                } else if (selectedValue.value === 'Fast') {
                                    let formattedPrice = selectedValue.nextElementSibling.nextElementSibling.textContent;
                                    estimatedTime = "{% for fast in estimated_time_fast %} {{ fast }} {% endfor %}";
                                    add.innerHTML = `<div class="selectedValue">${selectedValue.value}</div> <div class="formattedPrice">${formattedPrice}</div> <div class="estimated-Time"> Estimated Time: </div> <div class="estimatedTime">${estimatedTime}</div>`;
                                    // Set the style
                                    add.classList.add('showSelectedTypes')
                                } else if (selectedValue.value === 'Cargo') {
                                    let formattedPrice = selectedValue.nextElementSibling.nextElementSibling.textContent;
                                    estimatedTime = "{% for cargo in estimated_time_cargo %} {{ cargo }} {% endfor %}";
                                    add.innerHTML = `<div class="selectedValue">${selectedValue.value}</div> <div class="formattedPrice">${formattedPrice}</div> <div class="estimated-Time"> Estimated Time: </div> <div class="estimatedTime">${estimatedTime}</div>`;
                                    // Set the style
                                    add.classList.add('showSelectedTypes')
                                }

                                // Update summaryCheckout after selecting delivery type
                                updateSummaryCheckout();
                            });
                        } else {
                            // Remove the product from checkout lists
                            let listItem = checkoutLists.querySelector(`li[data-id="${productId}"]`);
                            if (listItem) {
                                listItem.remove();
                            }
                        }

                        // update hidden input with the current quantity
                        document.getElementById('quantity_input_' + productId).value = productQuantity;

                        // Toggle checkout list visibility
                        toggleCheckoutListVisibility();

                        // Update summaryCheckout after adding or removing product
                        updateSummaryCheckout();
                    });
                });

                // Payment MIDTRANS FORM
                paymentButton.addEventListener('click', async () => {
                    // const formData = new FormData(form);
                    const formData = new FormData(midtransForm);
                    const objectData = {};
                    formData.forEach((value, key) => {
                        objectData[key] = value;
                    });
                    console.log('object data:', objectData);

                    // Collect product data from the DOM
                    const productNames = [];
                    const totalProducts = [];
                    const totalPrices = [];
                    const shippingOptions = [];

                    const itemsList = document.getElementById("checkout-items");
                    itemsList.querySelectorAll("li").forEach(item => {
                        const name = item.getAttribute("data-name");
                        console.log("Checking item:", item);
                        console.log("Product Name Check:", name);

                        const quantityElement = item.querySelector("span").textContent.match(/Quantity: (\d+)/);
                        const priceElement = item.querySelector("span").textContent.match(/-\s*Rp\.([\d.]+)/);
                        const deliveryCostElement = item.querySelector(".formattedPrice")?.textContent.match(/Rp\.([\d.]+)/);

                        console.log('quantityElement:', quantityElement);
                        console.log('priceElement:', priceElement);
                        console.log('Cost Delivery Element:', deliveryCostElement);

                        const quantity = parseInt(quantityElement[1], 10);
                        const price = parseInt(priceElement[1].replace(/\./g, ''), 10);
                        const deliveryCost = parseInt(deliveryCostElement[1].replace(/\./g, ''), 10);

                        console.log('quantityFinal:', quantity);
                        console.log('priceFinal:', price);
                        console.log('Delivery Cost:', deliveryCost);

                        productNames.push(name);
                        totalProducts.push(quantity);
                        totalPrices.push(price);
                        shippingOptions.push(deliveryCost)
                    });

                    console.log('productNames final:', productNames);
                    console.log('totalProducts final:', totalProducts);
                    console.log('totalPrices final:', totalPrices);
                    console.log('shippingOptions final:', shippingOptions);

                    // Convert data into Json
                    try {
                        const parsedProductNames = JSON.parse(objectData.productNames || '[]');
                        const parsedTotalProducts = JSON.parse(objectData.totalQuantity || '[]');
                        const parsedDeliveryCost = shippingOptions;
                        const parsedTotalPrices = totalPrices;
                        console.log('parsedProductNames ye:', parsedProductNames)
                        console.log('parsedTotalProducts ye:', parsedTotalProducts)
                        console.log('parsedDeliveryCost ye:', parsedDeliveryCost)
                        console.log('parsedTotalPrices ye:', parsedTotalPrices)

                        // Combine product data into items array
                        const items = parsedProductNames.map((name, index) => {
                            const quantity = parseFloat(parsedTotalProducts);
                            const price = parseFloat(parsedTotalPrices);
                            const delivery = parseFloat(parsedDeliveryCost);
                            console.log(`Item ${index}: name=${name}, quantity=${quantity}, delivery=${delivery}, price=${price}`);

                            return {
                                id: index + 1,
                                name: name,
                                quantity : quantity,
                                delivery : delivery,
                                price: price,
                            };
                        });

                        // Calculate total cost
                        const totalCosts = items.reduce((sum, item) => {
                            const itemTotal = item.price * item.quantity;
                            console.log(`Item total for ${item.name}: ${itemTotal}`);
                            return sum + itemTotal;
                        }, 0);
                        console.log('totalCosts hasil calculate:', totalCosts)

                        // Modify into JSON format
                        const requestData = {
                            ...objectData,
                            items: items,
                            totalCosts: totalCosts,
                        };

                        try {
                            const response = await fetch('http://127.0.0.1:8000/create_midtrans_transaction', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                },
                                credentials: 'include',
                                body: JSON.stringify(requestData),
                            });
                            const result = await response.json();
                            console.log('result:', result);
                            const token = result.transaction_token;
                            console.log('tokennya:', token);
                            // window.snap.pay(token);

                            // if (window.snap && window.snap.pay) {
                            if (window.snap && window.snap.embed) {
                                // window.snap.pay(token);
                                document.getElementById('midtrans-payment-method').style.display = 'block';
                                window.snap.embed(token, {
                                    embedId: 'midtrans-payment-method',
                                });
                            } else {
                                console.error('Snap.js is not loaded properly');
                            }
                        } catch (error) {
                            console.log(error.message);
                        }
                    } catch (error) {
                        console.log('JSON parse error:', error.message);
                    }

                    toggleCheckoutListVisibility();
                    updateSummaryCheckout();
                });
            });

            // Send data in 'checkout list' into whatsapp
            checkoutButton.addEventListener("click", () => {
                if (checkoutButton.classList.contains("disabled")) {
                    return;
                }

                // Get whatsapp number from views.py
                const phoneNumber = "{{ phone_number }}";

                // Get customer/buyer details
                const buyerName = document.getElementById("buyer-name").textContent.trim();
                const buyerContact = document.getElementById("buyer-contact").textContent.trim();
                const buyerAddress = document.getElementById("text_address").textContent.trim();

                // Get productId from checkout list
                let productIds = [];
                // console.log("product id list:", productIds);

                let productNames = [];
                // console.log("product name lists:", productNames)

                let deliveryDetails = [];

                const checkoutLists = document.getElementById("checkout-items");

                checkoutLists.querySelectorAll("li").forEach(item => {
                    const productId = item.getAttribute("data-id");
                    const productName = item.getAttribute("data-name");
                    const selectedValue = item.querySelector(".selectedValue")?.textContent || '';
                    const formattedPrice = item.querySelector(".formattedPrice")?.textContent || '';
                    const estimatedTime = item.querySelector(".estimatedTime")?.textContent || '';

                    productIds.push(productId);
                    productNames.push(productName);

                    deliveryDetails.push({
                        selectedValue,
                        formattedPrice,
                        estimatedTime
                    });
                });

                // Get data from summaryCheckout
                const summaryData = {
                    productOrdered: document.getElementById("productNumbers").textContent,
                    productQuantity: document.getElementById("totalProducts").textContent,
                    totalCost: document.getElementById("totalCost").textContent
                };

                // Format the message for Whatsapp
                let message = `~ Checkout Details ~\n\n`;

                // Customer details
                message += `Recipient: ${buyerName}\n`;
                message += `Contact: ${buyerContact}\n`;
                message += `Address: ${buyerAddress}\n`;
                message += `\n`;

                // To separate product into sections
                productIds.forEach((id, index) => {
                    message += `Product Id: ${id}\n`;
                    message += `Product Name: ${productNames[index]}\n`;
                    message += `Delivery Type: ${deliveryDetails[index].selectedValue}\n`;
                    message += `Delivery Price: ${deliveryDetails[index].formattedPrice}\n`;
                    message += `Estimated Time: ${deliveryDetails[index].estimatedTime}\n`;
                    message += `-----------------------------------------------------------------------------------\n`;
                });
                
                message += `\nProduct Ordered: ${summaryData.productOrdered}\n`;
                message += `Product Quantity: ${summaryData.productQuantity}\n`;
                message += `Total Cost: ${summaryData.totalCost}\n`;

                // Encode the message for URL
                // const encodedMessage = encodeURIComponent(message);

                // Open Whatsapp URL
                // const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappURL, '_blank');
            });
            
        </script>
    </body>
{% endblock %}